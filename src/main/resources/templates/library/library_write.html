<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/common_layout.html}" th:with="activeTab='library'">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/library/library_write.css}">
</head>

<body>
<th:block layout:fragment="content">
    <section>

        <div class="container">
            <form name="recode-dto" th:action="@{/recode}" th:object="${recodeDto}" method="post" id="recodeForm">
                <div class="row">
                    <div class="col-2">
                        <div class="progress-box">
                            <br>
                            <ul id="progressbar">
                                <li class="active" id="info"></li>
                                <h6>정보 입력</h6>
                                <p>●</p>
                                <li id="write"></li>
                                <h6>후기 작성</h6>
                                <p>●</p>
                                <li id="upload"></li>
                                <h6>이미지 업로드</h6>
                                <li id="finish"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-10">
                        <!-- 정보 입력 -->
                        <fieldset>
                            <div class="info-box">
                                <h2>정보 입력</h2>
                                <p style="color: tomato"><small> * 는 필수 입력란 입니다.</small></p>
                                <div class="row">
                                    <!-- --------------------- 정보 입력 -------------------- -->
                                    <div class="col-6">

                                        <label style="color: tomato">*</label>
                                        <label for="title">제목: </label>
                                        <div class="form-box">
                                            <input type="text" th:field="*{title}" id="title" placeholder="제목" name="title">
                                        </div>
                                        <label>테마 검색 : </label>
                                        <div class="form-box">
                                            <input id="theme-no" th:field="*{themeNo}" type="hidden">
                                            <input id="theme-name" type="text" readonly>
                                            <button id="theme-info-remove-btn" type="button"
                                                    class="btn">&times;</button>
                                            <button type="button" class="btn search-btn" data-toggle="modal"
                                                    data-target="#selectModal">
                                                테마 검색
                                            </button>
                                        </div>
                                        <!-- 테마 검색 모달 -->
                                        <div class="modal" id="selectModal">
                                            <div class="modal-dialog">
                                                <div class="modal-content">

                                                    <div class="modal-header">
                                                        <h4 class="modal-title">테마 검색</h4>
                                                        <button type="button" class="close"
                                                                data-dismiss="modal">&times;</button>
                                                    </div>

                                                    <div class="modal-body">
                                                        <label>테마 검색 : </label>
                                                        <div class="form-inline">
                                                            <form class="form-inline">
                                                                <input class="form-control mr-sm-2" id="keyword" type="text"
                                                                       placeholder="테마명 또는 지점 검색">
                                                                <button class="btn btn-success" id="theme-search-btn"
                                                                        type="button">
                                                                    검색하기
                                                                </button>
                                                            </form>
                                                        </div>

                                                        <div class="mt-4" id="theme-search-result">
                                                            <p>검색 결과</p>
                                                            <ul id="theme-list" class="list-group theme-search">
                                                                <li class="list-group-item list-group-item-action"
                                                                    th:each="theme,num:${themeList}" th:value="${theme.no}"
                                                                    th:text="${theme.themeName}+'/'+${theme.shopName}">
                                                                </li>
                                                            </ul>
                                                        </div>

                                                        <div class="modal-footer">
                                                            <button id="theme-select-btn" type="button"
                                                                    class="btn btn-primary">선택</button>
                                                            <button type="button" class="btn btn-danger"
                                                                    data-dismiss="modal">닫기
                                                            </button>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="right-box">
                                            <a data-toggle="modal" data-target="#themeModal">원하는 테마 정보가 없나요?</a>
                                        </div>

                                        <!-- 정보입력- 테마검색 모달 ! -->
                                        <div class="modal fade" id="themeModal" tabindex="-1" role="dialog"
                                             aria-labelledby="themeModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">새로운 테마가 있나요?</h5>
                                                        <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="feedback-form" th:object="${feedbackForm}">
                                                            <div class="form-group">
                                                                <label for="theme-name" class="col-form-label">테마명:</label>
                                                                <input type="text" class="form-control" id="new-theme-name"
                                                                       th:field="*{newThemeName}">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="sel1">지역 선택:</label>
                                                                <select class="form-control" id="sel1"
                                                                        th:field="*{areaType}">
                                                                    <option
                                                                            th:each="areaTypeValue : ${T(com.recoders.escapelog.domain.AreaType).values()}"
                                                                            th:value="${areaTypeValue.name()}"
                                                                            th:text="${areaTypeValue.getKrName()}">
                                                                </select>
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="message-text" class="col-form-label">내용:</label>
                                                                <textarea class="form-control" id="message-text"
                                                                          th:field="*{contents}"></textarea>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-primary"
                                                                id="feedback-submit-btn">제출하기</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-6">
                                                <!-- --------------------- 평점 -------------------- -->
                                                <div>
                                                    <label style="color: tomato">*</label>
                                                    <label>평점: </label>
                                                </div>
                                                <div>
                                                    <div class="rating-box">
                                                        <input type="radio" th:field="*{rating}" name="rating" value="5"
                                                               id="rate5"><label for="rate5">★</label>
                                                        <input type="radio" th:field="*{rating}" name="rating" value="4"
                                                               id="rate4"><label for="rate4">★</label>
                                                        <input type="radio" th:field="*{rating}" name="rating" value="3"
                                                               id="rate3"><label for="rate3">★</label>
                                                        <input type="radio" th:field="*{rating}" name="rating" value="2"
                                                               id="rate2"><label for="rate2">★</label>
                                                        <input type="radio" th:field="*{rating}" name="rating" value="1"
                                                               id="rate1"><label for="rate1">★</label>
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="col-6">
                                                <!-- --------------------- 탈출 여부 -------------------- -->

                                                <div>
                                                    <label style="color: tomato">*</label>
                                                    <label>탈출 여부: </label>
                                                </div>
                                                <div class="success-box">
                                                    <input type="radio" id="success1" th:field="*{success}" name="success" value="true">
                                                    <label for="success1">탈출 성공</label>
                                                    <input type="radio" id="success2" th:field="*{success}" name="success" value="false">
                                                    <label for="success2">탈출 실패</label>
                                                </div>
                                            </div>
                                        </div>



                                    </div>
                                    <div class="col-6">
                                        <!-- --------------------- 탈출 시간 -------------------- -->
                                        <div>
                                            <label>탈출 시간: </label>
                                        </div>
                                        <div class="form-box">
                                            <input type="number" th:field="*{breakTime.min}" min="0" max="99999"> 분&emsp;
                                            <input type="number" th:field="*{breakTime.sec}" min="0" max="99999"> 초&emsp;
                                        </div>

                                        <div>
                                            <label>힌트 사용 : </label>
                                        </div>
                                        <div class="form-box">
                                            <input type="number" th:field="*{hint}" min="0" max="99999">
                                            개&emsp;
                                        </div>


                                        <div>
                                            <label>인원 : </label>
                                        </div>
                                        <div class="form-box">
                                            <input type="number" th:field="*{playerNum}" min="1" max="8" tabindex="1">
                                            명&emsp;
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <button type="button" id="email-check-btn" class="next btn btn-next">다음</button>
                        </fieldset>

                        <!-- 후기 작성 -->
                        <fieldset>
                            <div class="write-box">
                                <h2>
                                    <span style="color: tomato;">*</span>
                                    후기 작성
                                </h2>
                                <label style="color: tomato">*</label>
                                <div class="success-box">
                                    <input type="radio" id="secret2" th:field="*{secret}" name="secret" value="true">
                                    <label for="secret2">비공개</label>
                                    <input type="radio" id="secret1" th:field="*{secret}" name="secret" value="false">
                                    <label for="secret1">공개</label>
                                </div>
                                <textarea class="form-control" name="contents" th:field="*{contents}" id="contents"
                                          rows="20"></textarea>

                            </div>
                            <button type="button" id="code-check-btn" class="next btn btn-next">다음</button>
                            <button type="button" name="previous" class="previous btn action-button-previous"
                                    value="Previous">이전</button>
                        </fieldset>

                        <!-- 이미지 업로드 -->
                        <fieldset>
                            <div class="upload-box">
                                <h2>이미지 업로드</h2>
                                <p>추억하고 싶은 이미지를 추가해보세요</p>
                                <div class="p-5" style="border:2px dashed #474249">
                                    <label for="image-file">이미지 업로드</label>
                                    <input type="file" class="form-control-file" id="image-file">
                                </div>
                            </div>
                            <input type="button" th:onclick="" class="btn btn-next" id="save-recode" value="글쓰기 완료"/>
                            <button type="button" name="previous" class="previous btn action-button-previous"
                                    value="Previous">이전</button>
                        </fieldset>
                    </div>
                </div>
            </form>
        </div>





        <script>
            $(document).ready(function () {

                let current_fs, next_fs, previous_fs; //fieldsets
                let opacity;
                let current = 1;
                let steps = $("fieldset").length;

                setProgressBar(current);

                $(".next").click(function () {

                    current_fs = $(this).parent();
                    next_fs = $(this).parent().next();

                    //Add Class Active
                    $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

                    //show the next fieldset
                    next_fs.show();
                    //hide the current fieldset with style
                    current_fs.animate({ opacity: 0 }, {
                        step: function (now) {
                            // for making fielset appear animation
                            opacity = 1 - now;

                            current_fs.css({
                                'display': 'none',
                                'position': 'relative'
                            });
                            next_fs.css({ 'opacity': opacity });
                        },
                        duration: 500
                    });
                    setProgressBar(++current);
                });

                $(".previous").click(function () {

                    current_fs = $(this).parent();
                    previous_fs = $(this).parent().prev();

                    //Remove class active
                    $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");

                    //show the previous fieldset
                    previous_fs.show();

                    //hide the current fieldset with style
                    current_fs.animate({ opacity: 0 }, {
                        step: function (now) {
                            // for making fielset appear animation
                            opacity = 1 - now;

                            current_fs.css({
                                'display': 'none',
                                'position': 'relative'
                            });
                            previous_fs.css({ 'opacity': opacity });
                        },
                        duration: 500
                    });
                    setProgressBar(--current);
                });

                function setProgressBar(curStep) {
                    var percent = parseFloat(100 / steps) * curStep;
                    percent = percent.toFixed();
                    $(".progress-bar")
                        .css("width", percent + "%")
                }

                $(".submit").click(function () {
                    return false;
                })

            });
        </script>


        <script>
            $(document).ready(function () {

                let selectedThemeName = "";
                let selectedThemeNo = 0;

                function themeValueInit() {
                    selectedThemeNo = 0;
                    selectedThemeName = "";
                }

                $('#save-recode').click(function () {

                    let title = $('#title').val();
                    let success = $('input:radio[name=success]').is(':checked');
                    let rating = $('input:radio[name=rating]').is(':checked');
                    let contents = $('#contents').val();
                    let secret = $('input:radio[name=secret]').is(':checked');

                    if (title == '') {
                        alert('제목을 입력해주세요');
                        return false;
                    }

                    if (success == false) {
                        alert('탈출여부를 선택해주세요');
                        return false;
                    }

                    if (rating == false) {
                        alert('평점을 선택해주세요');
                        return false;
                    }

                    if (contents == '') {
                        alert('내용을 입력해주세요');
                        return false;
                    }

                    if (secret == false) {
                        alert('공개여부를 선택해주세요');
                        return false;
                    }


                    $('form[name=recode-dto]').submit()


                });

                $('#theme-search-btn').click(function () {
                    let keyword = $('#keyword').val().replace(/^\s+|\s+$/gm, '');

                    $.ajax({
                        url: '/recode/theme_search',
                        type: 'GET',
                        data: { keyword: keyword },
                    })
                        .done(function (fragment) {
                            $('#theme-list').replaceWith(fragment);
                            themeValueInit()
                        });
                });

                $("#theme-search-result").on("click", "li", function () {
                    selectedThemeNo = $(this).val();
                    selectedThemeName = $(this).text();


                });

                $('#theme-select-btn').click(function () {
                    if (!selectedThemeName | !selectedThemeName) {
                        alert("테마를 선택해주세요.");
                        return false;
                    }
                    document.getElementById("theme-no").value = selectedThemeNo;
                    document.getElementById("theme-name").value = selectedThemeName;
                    $('#selectModal').modal('hide');
                });

                $('#theme-info-remove-btn').click(function () {
                    themeValueInit()
                    document.getElementById("theme-no").value = null;
                    document.getElementById("theme-name").value = selectedThemeName;
                });

                $('#feedback-submit-btn').click(function () {

                    if ($('#new-theme-name').val().replace(/\s| /gi, "").length == 0) {
                        alert("테마명을 입력해주세요.");
                        return false;
                    }

                    var token = $("meta[name='_csrf']").attr("content");
                    var header = $("meta[name='_csrf_header']").attr("content");

                    document.getElementById("new-theme-name").value = $('#new-theme-name').val().replace(/^\s+|\s+$/gm, '');
                    document.getElementById("message-text").value = $('#message-text').val().replace(/^\s+|\s+$/gm, '');

                    $.ajax({
                        url: '/feedback/add',
                        type: 'POST',
                        data: $('#feedback-form').serialize(),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader(header, token);
                        },
                        success: function (data) {
                            $('#themeModal').modal("hide");
                            alert("의견을 주셔서 감사합니다.");
                            $("#sel1 option:eq(0)").prop("selected", true);
                            document.getElementById("new-theme-name").value = null;
                            document.getElementById("message-text").value = null;
                        },
                        error: function (request, status, error) {
                            console.log("code = " + request.status + " error = " + error);
                        }
                    })
                });
            });
        </script>
        </div>
    </section>
</th:block>
</body>
</html>